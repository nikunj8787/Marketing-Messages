import streamlit as st
import pandas as pd
import requests
import json
import time

# Load secrets
try:
    HF_TOKEN = st.secrets["huggingface"]["api_token"]
    EMI_LINK = st.secrets["links"]["emi_calculator"]
    VALUATION_LINK = st.secrets["links"]["valuation_calculator"]
except:
    st.error("Please set your API tokens and links in secrets.toml.")
    st.stop()

st.set_page_config(page_title="Gujarati Property Marketing", layout="wide")

# Gujarati static messages templates (columns A-L mapped)
STATIC_MESSAGES = [
    "‡™¶‡™ø‡™µ‡™∏ 1\nüè° ‡™ö‡™æ‡™≤‡´ã ‡™´‡™∞‡´Ä‡™•‡´Ä ‡™Ø‡™æ‡™¶ ‡™ï‡™∞‡´Ä‡™è ‡™ï‡´á ‡™ï‡´á‡™Æ ‡™§‡™Æ‡™®‡´á ‡™Ü ‡™ò‡™∞ ‡™™‡™∏‡™Ç‡™¶ ‡™Ü‡™µ‡´ç‡™Ø‡´Å‡™Ç ‡™π‡™§‡´Å‡™Ç!\nüìè {{E}} | {{F}} ‡™ï‡´ç‡™µ‡™æ‡™Ø‡™æ‡™∞‡´ç‡™° | {{I}}\nüìç {{H}} | {{G}} ‡™Æ‡™æ‡™≥\nüëâ ‡™∂‡´Å‡™Ç ‡™Ü‡™™‡™£‡´á ‡™§‡™Æ‡™æ‡™∞‡™æ ‡™Æ‡™æ‡™ü‡´á ‡™µ‡´á‡™ö‡™®‡™æ‡™∞ ‡™∏‡™æ‡™•‡´á ‡™Æ‡´Ä‡™ü‡™ø‡™Ç‡™ó ‡™´‡™ø‡™ï‡´ç‡™∏ ‡™ï‡™∞‡´Ä‡™è?\n‡™∞‡™ø‡™™‡´ç‡™≤‡™æ‡™Ø ‡™ï‡™∞‡´ã YES ‡™ú‡´ã ‡™∞‡™∏ ‡™π‡´ã‡™Ø ‡™§‡´ã, No ‡™ú‡´ã ‡™® ‡™π‡´ã‡™Ø ‡™§‡´ã.",
    "‡™¶‡™ø‡™µ‡™∏ 2\nüìç {{A}} ‡™´‡™ï‡´ç‡™§ ‡™≤‡´ã‡™ï‡´á‡™∂‡™® ‡™®‡™•‡´Ä, ‡™è ‡™≤‡™æ‡™á‡™´‡™∏‡´ç‡™ü‡™æ‡™á‡™≤ ‡™õ‡´á.\n‡™∏‡´ç‡™ï‡´Ç‡™≤, ‡™ï‡´ã‡™≤‡´á‡™ú, ‡™π‡´ã‡™∏‡´ç‡™™‡™ø‡™ü‡™≤, ‡™∂‡´ã‡™™‡™ø‡™Ç‡™ó ‡™Æ‡´ã‡™≤ ‡™¨‡™ß‡´Å‡™Ç ‡™®‡™ú‡´Ä‡™ï‡™Æ‡™æ‡™Ç ‡™õ‡´á.\nüëâ ‡™∞‡™ø‡™™‡´ç‡™≤‡™æ‡™Ø ‡™ï‡™∞‡´ã YES ‡™ú‡´ã ‡™∞‡™∏ ‡™π‡´ã‡™Ø ‡™§‡´ã, No ‡™ú‡´ã ‡™® ‡™π‡´ã‡™Ø ‡™§‡´ã.",
    "‡™¶‡™ø‡™µ‡™∏ 3\nüé• ‡™Ü ‡™∂‡´ã‡™∞‡´ç‡™ü ‡™µ‡™ø‡™°‡™ø‡™Ø‡´ã ‡™Æ‡™æ‡™Ç ‡™´‡™∞‡´Ä‡™•‡´Ä ‡™ò‡™∞ ‡™ú‡´Å‡™ì!\n‡™ò‡™∞‡™®‡™æ ‡™≤‡´á‡™Ü‡™â‡™ü ‡™Ö‡™®‡´á ‡™≤‡™æ‡™á‡™ü‡™ø‡™Ç‡™ó ‡™∏‡™Æ‡™ú‡™µ‡´Å‡™Ç ‡™π‡™µ‡´á ‡™∏‡™∞‡™≥ ‡™õ‡´á.\nüëâ {{L}}\nüëâ ‡™∞‡™ø‡™™‡´ç‡™≤‡™æ‡™Ø ‡™ï‡™∞‡´ã YES ‡™ú‡´ã ‡™∞‡™∏ ‡™π‡´ã‡™Ø ‡™§‡´ã, No ‡™ú‡´ã ‡™® ‡™π‡´ã‡™Ø ‡™§‡´ã.",
    "‡™¶‡™ø‡™µ‡™∏ 4\nüß≠ {{A}} ‡™®‡´Ä ‡™°‡™ø‡™ú‡™ø‡™ü‡™≤ ‡™Æ‡´Å‡™≤‡™æ‡™ï‡™æ‡™§ ‡™≤‡´ã, ‡™è ‡™™‡™£ ‡™Æ‡´ã‡™¨‡™æ‡™á‡™≤ ‡™™‡™∞‡™•‡´Ä!\n‡™¶‡™∞‡´á‡™ï ‡™ñ‡´Ç‡™£‡™æ‡™®‡´Å‡™Ç 360¬∞ ‡™ü‡´Ç‡™∞ ‡™ú‡´Å‡™ì.\nüëâ {{K}}\nüëâ ‡™∞‡™ø‡™™‡´ç‡™≤‡™æ‡™Ø ‡™ï‡™∞‡´ã YES ‡™ú‡´ã ‡™∞‡™∏ ‡™π‡´ã‡™Ø ‡™§‡´ã, No ‡™ú‡´ã ‡™® ‡™π‡´ã‡™Ø ‡™§‡´ã.",
    "‡™¶‡™ø‡™µ‡™∏ 5\nüí∞ {{A}} ‚Çπ{{D}} ‡™Æ‡™æ‡™Ç ‡™è‡™ï ‡™â‡™§‡´ç‡™§‡™Æ ‡™ì‡™™‡´ç‡™∂‡™® ‡™õ‡´á!\n‡™Ü ‡™ú ‡™∏‡´ã‡™∏‡™æ‡™Ø‡™ü‡´Ä‡™Æ‡™æ‡™Ç ‡™Ü‡™µ‡´Ä ‡™ï‡™ø‡™Ç‡™Æ‡™§‡™®‡´Ä ‡™ò‡™£‡´Ä ‡™°‡´Ä‡™≤‡´ç‡™∏ ‡™•‡™á ‡™ö‡´Ç‡™ï‡´Ä ‡™õ‡´á.\nüëâ ‡™∂‡´Å‡™Ç ‡™Ö‡™Æ‡´á ‡™µ‡´á‡™ö‡™®‡™æ‡™∞ ‡™∏‡™æ‡™•‡´á ‡™≠‡™æ‡™µ ‡™µ‡™æ‡™§ ‡™Æ‡™æ‡™ü‡´á ‡™Æ‡´Ä‡™ü‡™ø‡™Ç‡™ó ‡™´‡™ø‡™ï‡´ç‡™∏ ‡™ï‡™∞‡´Ä‡™è? ‡™∞‡™ø‡™™‡´ç‡™≤‡™æ‡™Ø ‡™ï‡™∞‡´ã YES.",
    "‡™¶‡™ø‡™µ‡™∏ 6\nü§ù Cleardeals ‡™∏‡™æ‡™•‡´á ‡™§‡™Æ‡™æ‡™∞‡´Å‡™Ç ‡™ò‡™∞ ‡™ñ‡™∞‡´Ä‡™¶‡™µ‡´Å‡™Ç ‡™π‡™µ‡´á ‡™µ‡™ß‡´Å ‡™∏‡™∞‡™≥ ‡™õ‡´á!\n‚úÖ 0% ‡™¨‡´ç‡™∞‡´ã‡™ï‡™∞‡´á‡™ú\n‚úÖ ‡™®‡´á‡™ó‡´ã‡™∂‡™ø‡™è‡™∂‡™® ‡™∏‡™™‡´ã‡™∞‡´ç‡™ü\n‚úÖ ‡™≤‡´ã‡™® ‡™Ö‡™®‡´á ‡™≤‡´Ä‡™ó‡™≤ ‡™∏‡™π‡™æ‡™Ø ‚Äî ‡™¨‡™ß‡´Å‡™Ç ‡™è‡™ï‡™ú ‡™ú‡™ó‡´ç‡™Ø‡™æ ‡™è\nCheck Loan EMI for {{A}}: https://lnk.ink/FUwEc\nüëâ ‡™∂‡´Å‡™Ç ‡™π‡™µ‡´á ‡™µ‡´á‡™ö‡™®‡™æ‡™∞ ‡™∏‡™æ‡™•‡´á ‡™Æ‡´Å‡™≤‡™æ‡™ï‡™æ‡™§ ‡™∞‡™æ‡™ñ‡´Ä ‡™´‡™æ‡™à‡™®‡™≤ ‡™∏‡´ç‡™ü‡´á‡™™ ‡™≤‡™à‡™è? ‡™∞‡™ø‡™™‡´ç‡™≤‡™æ‡™Ø ‡™ï‡™∞‡´ã YES.",
    "‡™¶‡™ø‡™µ‡™∏ 7\n‡™∂‡´Å‡™Ç ‡™§‡™Æ‡´á {{A}} ‡™®‡´Ä ‡™™‡´ç‡™∞‡´ã‡™™‡™∞‡´ç‡™ü‡´Ä‡™®‡´Å‡™Ç ‡™µ‡´á‡™≤‡´ç‡™Ø‡´Ç‡™è‡™∂‡™® ‡™ú‡™æ‡™£‡™µ‡™æ ‡™Æ‡™æ‡™Ç‡™ó‡´ã ‡™õ‡´ã?\n‡™ö‡´á‡™ï ‡™ï‡™∞‡´ã: https://lnk.ink/fkYwF\nüëâ ‡™∂‡´Å‡™Ç ‡™π‡™µ‡´á ‡™µ‡´á‡™ö‡™®‡™æ‡™∞ ‡™∏‡™æ‡™•‡´á ‡™Æ‡´Å‡™≤‡™æ‡™ï‡™æ‡™§ ‡™∞‡™æ‡™ñ‡´Ä ‡™´‡™æ‡™à‡™®‡™≤ ‡™∏‡´ç‡™ü‡´á‡™™ ‡™≤‡™à‡™è? ‡™∞‡™ø‡™™‡´ç‡™≤‡™æ‡™Ø ‡™ï‡™∞‡´ã YES.",
    "‡™¶‡™ø‡™µ‡™∏ 8\nüïí ‡™∂‡´Å‡™Ç ‡™§‡™Æ‡´á ‡™π‡™ú‡´Å ‡™à‡™®‡´ç‡™ü‡™∞‡´á‡™∏‡´ç‡™ü‡´á‡™° ‡™õ‡´ã ‡™ï‡´á ‡™®‡™π‡´Ä‡™Ç?\n‡™ú‡´ã ‡™π‡™ú‡´Ä ‡™µ‡™ø‡™ö‡™æ‡™∞‡™Æ‡™æ‡™Ç ‡™õ‡´ã ‡™§‡´ã ‡™Ö‡™Æ‡´á ‡™≤‡´ã‡™ï‡™Ö‡™™ ‡™¨‡™Ç‡™ß ‡™ï‡™∞‡´Ä‡™∂‡´Å‡™Ç ‚Äî ‡™π‡™µ‡´á ‡™®‡™ø‡™∞‡´ç‡™£‡™Ø‡™®‡´ã ‡™∏‡™Æ‡™Ø ‡™õ‡´á!\nüëâ ‡™∂‡´Å‡™Ç ‡™™‡´ç‡™∞‡´ã‡™™‡™∞‡´ç‡™ü‡´Ä ‡™Æ‡™æ‡™ü‡´á ‡™Ü‡™ó‡™≥ ‡™µ‡™ß‡™µ‡´Å‡™Ç ‡™õ‡´á? ‡™∞‡™ø‡™™‡´ç‡™≤‡™æ‡™Ø ‡™ï‡™∞‡´ã YES."
]

# Function to replace placeholders with actual data
def fill_template(template, data):
    for key, val in data.items():
        template = template.replace(f"{{{{{key}}}}}", val)
    return template

# Function to generate Gujarati messages via LLM
def generate_gujarati_message(property_data, message_type, nearby_info):
    prompt = f"""
    Create a professional Gujarati marketing message for a home buyer based on these details:
    Project: {property_data['A']}
    City: {property_data['B']}
    Locality: {property_data['C']}
    Price: {property_data['D']}
    BHK: {property_data['E']}
    Area: {property_data['F']}
    Floor: {property_data['G']}
    Facing: {property_data['H']}
    Furnishing: {property_data['I']}
    Age: {property_data['J']}
    360 Tour Link: {property_data['K']}
    Video Link: {property_data['L']}
    Nearby Schools: {nearby_info['schools']}
    Nearby Hospitals: {nearby_info['hospitals']}
    Nearby Malls: {nearby_info['malls']}
    Use a friendly, persuasive tone, 4-5 lines, emojis, and end with:
    "Reply with a 'Hi' to take this deal forward."
    "www.cleardeals.co.in, No Brokerage Realtor."
    Focus on {message_type}.
    """
    headers = {"Authorization": f"Bearer {HF_TOKEN}"}
    payload = {
        "inputs": prompt,
        "parameters": {"max_new_tokens": 250, "temperature": 0.7}
    }
    try:
        response = requests.post(f"https://api-inference.huggingface.co/models/microsoft/DialoGPT-medium", headers=headers, json=payload, timeout=60)
        if response.status_code == 200:
            result = response.json()
            if isinstance(result, list) and len(result) > 0:
                return result[0].get("generated_text", "").strip()
            elif isinstance(result, dict):
                return result.get("generated_text", "").strip()
    except:
        pass
    return "Error generating message."

# Main app
st.title("üè° Gujarati Home Buyer Marketing Messages")
uploaded_file = st.file_uploader("Upload Data (CSV/XLS)", type=["csv","xls","xlsx"])

generate_mode = st.radio("Choose Mode", ["Static Templates", "LLM-Powered"], index=0)

if uploaded_file:
    if uploaded_file.name.endswith('.csv'):
        df = pd.read_csv(uploaded_file)
    else:
        df = pd.read_excel(uploaded_file)
    df.columns = [col.strip() for col in df.columns]
    # Map columns A-L
    col_map = {
        "A": "Project Name/Location",
        "B": "City",
        "C": "Locality",
        "D": "Price",
        "E": "BHK",
        "F": "Area",
        "G": "Floor",
        "H": "Facing",
        "I": "Furnishing",
        "J": "Age",
        "K": "360 Tour Link",
        "L": "Video Link"
    }
    # Create a dict for each property
    for idx, row in df.iterrows():
        data = {}
        for col_key, col_name in col_map.items():
            data[col_key] = row.get(col_name, "NA") if col_name in df.columns else "NA"
        # Clean data
        for k in data:
            if pd.isna(data[k]):
                data[k] = "NA"
        # Process location
        data["A"] = data["A"]
        data["C"] = data["C"]
        # Fetch nearby info
        with st.spinner(f"Fetching nearby places for {data['A']}..."):
            nearby = {
                "schools": [],
                "hospitals": [],
                "malls": []
            }
            # Geocode address
            full_addr = f"{data['A']}, {data['C']}, {data['B']}"
            lat, lon = None, None
            try:
                resp = requests.get(f"https://api.geoapify.com/v1/geocode/search?text={full_addr}&apiKey={GEOAPIFY_API_KEY}")
                if resp.status_code == 200 and resp.json()["features"]:
                    coords = resp.json()["features"][0]["geometry"]["coordinates"]
                    lat, lon = coords[1], coords[0]
            except:
                pass
            if lat and lon:
                for category in ["education.school", "education.college", "commercial.shopping_mall", "healthcare.hospital"]:
                    url = f"https://api.geoapify.com/v2/places?categories={category}&filter=circle:{lon},{lat},5000&limit=2&apiKey={GEOAPIFY_API_KEY}"
                    try:
                        r = requests.get(url)
                        if r.status_code == 200:
                            feats = r.json().get("features", [])
                            names = [f["properties"]["name"] for f in feats if "name" in f["properties"]]
                            if category == "education.school":
                                nearby["schools"] = names
                            elif category == "education.college":
                                nearby["colleges"] = names
                            elif category == "commercial.shopping_mall":
                                nearby["malls"] = names
                            elif category == "healthcare.hospital":
                                nearby["hospitals"] = names
                    except:
                        pass
            # Generate messages
            messages = []
            if generate_mode == "Static Templates":
                for i, template in enumerate(STATIC_MESSAGES):
                    msg = fill_template(template, data)
                    messages.append(msg)
            else:
                # LLM mode
                messages = []
                for i, mtype in enumerate([
                    "Property Benefits", "Location Advantage", "FOMO/Urgency", "Trust Building",
                    "Lifestyle Appeal", "Value Proposition", "Financial Assistance",
                    "Market Analysis"
                ]):
                    prompt = f"""
                    Create a Gujarati marketing message for a property:
                    Project: {data['A']}
                    Locality: {data['C']}
                    City: {data['B']}
                    Price: {data['D']}
                    BHK: {data['E']}
                    Area: {data['F']}
                    Facing: {data['H']}
                    Furnishing: {data['I']}
                    Age: {data['J']}
                    360 Tour: {data['K']}
                    Video: {data['L']}
                    Nearby Schools: {', '.join(nearby['schools'])}
                    Nearby Hospitals: {', '.join(nearby['hospitals'])}
                    Nearby Malls: {', '.join(nearby['malls'])}
                    Focus on: {mtype}
                    Use a friendly, persuasive tone, 4 lines, emojis, and end with:
                    "Reply with a 'Hi' to take this deal forward."
                    "www.cleardeals.co.in, No Brokerage Realtor."
                    """
                    msg = generate_gujarati_message(data, mtype, nearby)
                    # fallback if error
                    if not msg or "Error" in msg:
                        msg = fill_template(STATIC_MESSAGES[i], data)
                    messages.append(msg)
            # Show messages
            for idx, msg in enumerate(messages):
                st.markdown(f"### {['‡™¶‡™ø‡™µ‡™∏ 1','‡™¶‡™ø‡™µ‡™∏ 2','‡™¶‡™ø‡™µ‡™∏ 3','‡™¶‡™ø‡™µ‡™∏ 4','‡™¶‡™ø‡™µ‡™∏ 5','‡™¶‡™ø‡™µ‡™∏ 6','‡™¶‡™ø‡™µ‡™∏ 7','‡™¶‡™ø‡™µ‡™∏ 8'][idx]}")
                st.text_area(f"Message {idx+1}", msg, height=150)
            # Download all
            all_text = "\n\n".join(messages)
            st.download_button("Download All Messages (.txt)", all_text, filename=f"{data['A']}_Gujarati_Messages.txt")
